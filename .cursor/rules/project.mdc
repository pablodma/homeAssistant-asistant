---
description: Reglas del proyecto HomeAI Assistant (Bot Service)
globs:
  - "**/*"
---

# HomeAI Assistant - Bot Service

## Proyecto
- **Nombre**: HomeAI Assistant Bot
- **Repositorio**: git@github.com:pablodma/homeAssistant-asistant.git
- **Stack**: FastAPI + OpenAI (gpt-4.1-mini + gpt-4.1-nano) + Anthropic Claude (QA) + LangChain + asyncpg
- **Deploy**: Railway (https://homeai-assis-production.up.railway.app)
- **Fase actual**: 2 (MVP - Código propio, migrado de N8N)

## Arquitectura del Bot

```
┌─────────────────────────────────────────────────────────────────┐
│                    FLUJO DE MENSAJE                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Usuario                                                         │
│  (WhatsApp)                                                      │
│      │                                                           │
│      ▼                                                           │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    WEBHOOK (POST /webhook)                │   │
│  │  - Verifica signature de Meta                            │   │
│  │  - Parsea payload WhatsApp                               │   │
│  │  - Ejecuta en background task                            │   │
│  └────────────────────────┬─────────────────────────────────┘   │
│                           │                                      │
│                           ▼                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    ROUTER AGENT                           │   │
│  │  - LLM con tool calling (100% prompt-driven)             │   │
│  │  - Decide qué sub-agente usar                            │   │
│  │  - Ver ADR-002: docs/architecture/decisions/             │   │
│  └────────────────────────┬─────────────────────────────────┘   │
│                           │                                      │
│           ┌───────────────┼───────────────┐                     │
│           ▼               ▼               ▼                     │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                │
│  │   Finance   │ │   Agenda    │ │   Shopping  │ ...            │
│  │   Agent     │ │   Agent     │ │   Agent     │                │
│  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘                │
│         │               │               │                        │
│         ▼               ▼               ▼                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                │
│  │ Backend API │ │ Backend API │ │ PostgreSQL  │                │
│  │ (finance)   │ │ (agenda)    │ │ (directo)   │                │
│  └─────────────┘ └─────────────┘ └─────────────┘                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Polyrepo

```
Estructura local:
d:\Proyectos\homeAsiss\           ← Carpeta contenedora (NO es repo)
├── homeai-api/                   ← Backend FastAPI → Railway
├── homeai-web/                   ← Frontend Next.js → Vercel
├── homeai-admin/                 ← Panel Admin Next.js → Vercel
├── homeai-assis/                 ← ESTE PROYECTO (Bot → Railway)
└── .credentials/                 ← Credenciales locales

Repositorios GitHub:
├── homeAssistant-backend         
├── homeAssistant-frontend        
├── homeAssistant-admin           ← Panel de administración
└── homeAssistant-asistant        ← ESTE REPO
```

## Estructura del Proyecto

```
homeai-assis/
├── docs/prompts/                 # ⭐ PROMPTS DE AGENTES (archivos de config)
│   ├── finance-agent.md          # Prompt del agente de finanzas
│   ├── calendar-agent.md         # Prompt del agente de calendario
│   ├── router-agent.md           # Prompt del orquestador
│   ├── qa-agent.md               # Prompt del agente de QA
│   └── ...
├── src/app/
│   ├── main.py                   # FastAPI entry point
│   ├── config/
│   │   ├── settings.py           # Pydantic settings
│   │   └── database.py           # asyncpg pool
│   ├── whatsapp/
│   │   ├── types.py              # Pydantic models para payloads
│   │   ├── client.py             # WhatsAppClient (enviar mensajes)
│   │   └── webhook.py            # Router de webhook
│   ├── agents/
│   │   ├── base.py               # BaseAgent abstracto
│   │   ├── router.py             # RouterAgent (orquestador)
│   │   ├── finance.py            # FinanceAgent
│   │   ├── calendar.py           # CalendarAgent (name="agenda", prompt: calendar-agent.md)
│   │   ├── shopping.py           # ShoppingAgent
│   │   └── vehicle.py            # VehicleAgent
│   ├── services/
│   │   ├── conversation.py       # Manejo de memoria de chat
│   │   ├── prompt_loader.py      # Carga prompts desde archivos
│   │   └── interaction_log.py    # Logging de interacciones
│   └── repositories/
│       └── memory.py             # CRUD para chat memory
├── tests/
├── pyproject.toml
├── Dockerfile
└── README.md
```

## Agentes Implementados

### Router Agent (Orquestador)
- **Función**: Decide qué sub-agente debe manejar cada mensaje
- **Método**: LLM-only con tool calling (gpt-4.1-nano) - Ver ADR-002
- **Prompt**: `docs/prompts/router-agent.md`

### QA Agent (Control de Calidad)
- **Función**: Analiza cada interacción para detectar problemas de calidad
- **Método**: Anthropic Claude analiza mensaje_in + mensaje_out + tool_result
- **Ejecución**: Asíncrona (no agrega latencia a la respuesta del usuario)
- **Prompt**: `docs/prompts/qa-agent.md`

**Tipos de errores detectados:**
- `misinterpretation`: Bot malinterpretó el mensaje del usuario
- `hallucination`: Bot confirmó algo que no hizo
- `unsupported_case`: Usuario pidió algo no soportado
- `incomplete_response`: Respuesta falta información

### Sub-Agentes

| Agente | Backend/DB | Prompt |
|--------|------------|--------|
| **Finance** | Backend API | `docs/prompts/finance-agent.md` |
| **Agenda** | Backend API | `docs/prompts/calendar-agent.md` |
| **Shopping** | PostgreSQL directo | `docs/prompts/shopping-agent.md` |
| **Vehicle** | PostgreSQL directo | `docs/prompts/vehicle-agent.md` |
| **Subscription** | Backend API | `docs/prompts/subscription-agent.md` |

## Comunicación con Backend

El bot llama al backend para Finance y Agenda (calendar + reminders):

```python
# Finance - Registrar gasto
POST {BACKEND_API_URL}/api/v1/tenants/{tenant_id}/agent/expense
Authorization: Bearer {SERVICE_TOKEN}
{
    "description": "Supermercado",
    "amount": 5000,
    "user_phone": "+5491155555555"
}

# Calendar - Crear evento  
POST {BACKEND_API_URL}/api/v1/tenants/{tenant_id}/agent/calendar/events
Authorization: Bearer {SERVICE_TOKEN}
{
    "title": "Dentista",
    "start_datetime": "2026-02-10T10:00:00",
    "user_phone": "+5491155555555"
}
```

## Acceso Directo a DB

Shopping y Vehicles escriben directo a PostgreSQL. Agenda (calendar + reminders) usa Backend API.

| Tabla | Agente | Campos principales |
|-------|--------|-------------------|
| `shopping_items` | Shopping | tenant_id, list_name, item_name, quantity, purchased |
| `vehicles` | Vehicle | tenant_id, plate, brand, model, year |
| `vehicle_services` | Vehicle | vehicle_id, service_type, date, mileage, cost |
| `vehicle_reminders` | Vehicle | vehicle_id, type, due_date, mileage_due |

## Memoria de Conversación

- **Tabla**: `chat_sessions` + `chat_messages`
- **Expiración**: 24 horas de inactividad
- **Límite**: Últimos 10 mensajes como contexto para LLM

## Logging de Interacciones

Cada interacción se guarda en `agent_interactions`:

| Campo | Descripción |
|-------|-------------|
| `tenant_id` | Tenant del usuario |
| `user_phone` | Número de WhatsApp |
| `message_in` | Mensaje recibido |
| `message_out` | Respuesta enviada |
| `agent_used` | Agente que procesó |
| `tokens_in/out` | Tokens consumidos |
| `response_time_ms` | Tiempo de respuesta |
| `metadata` | JSON con detalles adicionales |

## Quality Logger

Errores técnicos y de calidad se guardan en `quality_issues`:

**Ubicación**: `src/app/services/quality_logger.py`

**Tipos de error:**
- **hard_error**: Errores técnicos (API, LLM, timeout, database)
- **soft_error**: Errores de calidad detectados por QA Agent

**Uso:**
```python
from ..services.quality_logger import get_quality_logger

quality_logger = get_quality_logger()

# Error duro (técnico)
await quality_logger.log_hard_error(
    tenant_id=tenant_id,
    category="api_error",
    error_message="Backend returned 500",
    agent_name="finance",
    tool_name="registrar_gasto",
    severity="high",
    exception=e,
)

# Error blando (QA)
await quality_logger.log_soft_error(
    tenant_id=tenant_id,
    interaction_id=interaction_id,
    category="hallucination",
    qa_analysis="El bot confirmó el gasto pero la API falló",
    qa_suggestion="Verificar resultado de herramienta antes de confirmar",
    qa_confidence=0.92,
)
```

**Panel de visualización:** homeai-admin → /quality

## Variables de Entorno

| Variable | Descripción | Requerida |
|----------|-------------|-----------|
| `WHATSAPP_PHONE_NUMBER_ID` | ID del número de WhatsApp | ✅ |
| `WHATSAPP_VERIFY_TOKEN` | Token para verificar webhook | ✅ |
| `WHATSAPP_ACCESS_TOKEN` | Token de Meta Business API | ✅ |
| `OPENAI_API_KEY` | API key de OpenAI | ✅ |
| `DATABASE_URL` | PostgreSQL (interno Railway) | ✅ |
| `DATABASE_PUBLIC_URL` | PostgreSQL (acceso externo) | Para migraciones |
| `BACKEND_API_URL` | URL del backend | ✅ |
| `DEFAULT_TENANT_ID` | Tenant por defecto (POC) | ✅ |
| `DEFAULT_SERVICE_TOKEN` | Token para llamadas al backend | ✅ |
| `PORT` | Puerto (Railway lo setea) | Auto |

## Webhook WhatsApp

### Verificación (GET /webhook)
```
GET /webhook?hub.mode=subscribe&hub.verify_token=TOKEN&hub.challenge=CHALLENGE
→ Retorna hub.challenge si token es válido
```

### Mensajes (POST /webhook)
```
POST /webhook
Content-Type: application/json

{
  "entry": [{
    "changes": [{
      "value": {
        "messages": [{
          "from": "5491155555555",
          "type": "text",
          "text": {"body": "Gasté 5000 en el super"}
        }]
      }
    }]
  }]
}
```

## Debugging con Railway MCP

```python
# Obtener logs de deploy
Railway_HomeAs-get-logs(
    workspacePath="d:\\Proyectos\\homeAsiss\\homeai-assis", 
    logType="deploy", 
    lines=100
)

# Buscar errores
Railway_HomeAs-get-logs(
    workspacePath="d:\\Proyectos\\homeAsiss\\homeai-assis", 
    logType="deploy", 
    filter="@level:error"
)

# Ver variables
Railway_HomeAs-list-variables(
    workspacePath="d:\\Proyectos\\homeAsiss\\homeai-assis"
)
```

## Prompts de Agentes

Los prompts viven en archivos de configuración (NO en base de datos):

```
docs/prompts/
├── finance-agent.md    # Agente de finanzas
├── calendar-agent.md   # Agenda Agent (eventos + recordatorios)
├── router-agent.md     # Orquestador principal
├── qa-agent.md         # Control de calidad
└── ...
```

### Para cambiar un prompt:
1. Editar `docs/prompts/{agent}-agent.md`
2. Commit + push
3. Railway redeploya automáticamente (~30 seg)

### Arquitectura prompt-first:
- La lógica de decisión va en el prompt, NO en código Python
- Ver reglas detalladas en `.cursor/rules/agents-architecture.mdc`

## Convenciones de Código

- **Python**: 3.11+
- **Type hints**: Obligatorios
- **Docstrings**: En todas las funciones públicas
- **Async/await**: Para todas las operaciones I/O
- **Logging**: structlog (JSON structured logs)
- **Formatter**: Black

## Testing Local

```bash
# Instalar dependencias
pip install -e .

# Ejecutar tests
pytest tests/

# Ejecutar servidor local
uvicorn src.app.main:app --reload --port 8000
```

Para testing de webhook local, usar ngrok:
```bash
ngrok http 8000
# Configurar URL de ngrok en Meta Developer Console
```

## Workflow de Desarrollo

1. **Editar código** → Test local
2. **Commit** → Push a main
3. **Railway** → Auto-deploy
4. **Monitorear** → Logs via MCP
5. **Verificar** → Enviar mensaje de prueba por WhatsApp

## Notas Importantes

- **SIEMPRE filtrar por tenant_id** en queries a DB
- **NO exponer tokens** en logs (usar masking)
- **Respuestas concisas** (WhatsApp tiene límite de 4096 chars)
- **Timeout de 3 segundos** ideal para respuestas
- **Background tasks** para procesamiento pesado (no bloquear webhook)
