---
description: Arquitectura y principios de diseño para agentes LLM
globs:
  - "**/agents/**"
  - "**/services/prompt_loader.py"
  - "**/docs/prompts/**"
alwaysApply: true
---

# Arquitectura de Agentes LLM - Principios Fundamentales

## Regla #1: PROMPT-FIRST (Obligatorio)

**La lógica de decisión SIEMPRE va en el prompt, NO en código Python.**

### ✅ Correcto (Prompt-driven)
```markdown
# En el prompt del agente (docs/prompts/finance-agent.md):
"ANTES de registrar un gasto, verificá que la categoría exista 
usando consultar_presupuesto. Si no existe, preguntá al usuario 
a cuál categoría quiere asignarlo."
```

El LLM decide cuándo preguntar basándose en las instrucciones del prompt.

### ❌ Incorrecto (Code-driven)
```python
# En finance.py:
if not self._match_category(user_category, categories):
    return {"needs_category_selection": True, ...}
```

El código está tomando decisiones que debería tomar el LLM.

---

## Regla #2: Prompts en Archivos de Configuración

**Los prompts viven en `docs/prompts/` como archivos markdown.**

```
docs/prompts/
├── finance-agent.md    # Prompt del agente de finanzas
├── calendar-agent.md   # Prompt del agente de calendario
├── router-agent.md     # Prompt del orquestador
├── qa-agent.md         # Prompt del agente de QA
└── ...
```

### Ventajas:
- ✅ Versionado en git (historial completo)
- ✅ Code review de cambios al prompt
- ✅ Una sola fuente de verdad
- ✅ Railway redeploya automáticamente al pushear

### Para cambiar un prompt:
1. Editar `docs/prompts/{agent}-agent.md`
2. Commit + push
3. Railway redeploya (~30 segundos)

### NO usar base de datos para prompts:
- Añade complejidad innecesaria
- Múltiples fuentes de verdad
- Difícil de versionar y revisar cambios

---

## Regla #3: Responsabilidades del Código vs Prompt

### El CÓDIGO debe:
- Ejecutar llamadas HTTP a APIs/backend
- Formatear respuestas para WhatsApp (sin markdown complejo)
- Manejar errores técnicos (timeouts, 500s)
- Logging y métricas

### El PROMPT debe:
- Definir cuándo usar cada herramienta
- Definir flujos de conversación (preguntar → esperar → actuar)
- Definir validaciones de negocio (ej: "no crear categorías nuevas")
- Definir el tono y formato de respuestas
- Definir cómo manejar casos ambiguos

---

## Regla #4: Herramientas (Tools) como Capacidades

Las tools son **capacidades**, no **lógica**.

### ✅ Tool bien diseñado
```python
{
    "name": "registrar_gasto",
    "description": "Registra un nuevo gasto",
    "parameters": {
        "amount": {"type": "number"},
        "category": {"type": "string"},
    }
}
```
La tool solo describe QUÉ puede hacer, no CUÁNDO usarla.

### ❌ Tool con lógica embebida
```python
# NO hacer esto en _execute_tool():
if not category_exists:
    return {"needs_category_selection": True}  # ❌ Decisión en código
```

El prompt debe instruir: "Si la categoría no existe, preguntá al usuario".

---

## Regla #5: Flujos Multi-turno

Para conversaciones que requieren múltiples intercambios, **usar el prompt**:

```markdown
"Si falta información, preguntá y esperá la respuesta del usuario 
antes de ejecutar la herramienta."
```

El historial de conversación permite al LLM continuar flujos multi-turno naturalmente.

---

## Regla #6: Validaciones de Negocio

### ❌ Validación en código
```python
def _execute_tool(self, ...):
    if category not in existing_categories:
        return error  # El código decide
```

### ✅ Validación en prompt
```markdown
"NUNCA crees categorías nuevas automáticamente. Si el usuario 
menciona una categoría que no existe, preguntá: '¿A cuál de 
estas categorías querés asignarlo?' y listá las existentes."
```

---

## Regla #7: Antes de Escribir Código para Agentes

### Checklist obligatorio:
- [ ] ¿Puedo lograr esto con cambios al prompt únicamente?
- [ ] ¿Estoy poniendo lógica de decisión en Python?
- [ ] ¿Estoy creando código que el LLM podría manejar naturalmente?

### Si respondés "sí" a cualquier pregunta → Revisá el approach.

---

## Estructura de un Prompt de Agente

Cada archivo en `docs/prompts/` debe tener:

```markdown
# Prompt: {Nombre} Agent

## Identidad
Quién es el agente, qué hace.

## Herramientas Disponibles
Lista de tools con descripción de cuándo usar cada una.

## Reglas de Comportamiento
Validaciones, flujos, restricciones.

## Tono y Estilo
Cómo debe comunicarse.

## Ejemplos
Casos de uso con el comportamiento esperado.
```

---

## Referencias

- Archivos de prompts: `docs/prompts/`
- Loader de prompts: `src/app/services/prompt_loader.py`
- Agentes: `src/app/agents/`
